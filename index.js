//======================设置参数==============================
const port = process.env.SERVER_PORT || 3000;
const vmms = process.env.MPATH || 'vms';  // vmes路径
const vmmport = process.env.MPORT || '8008';  // vmes端口
const uuid = process.env.UUID || '84fdecb7-6ebe-4aa3-9bd3-8b3b31d3dba1'; // 订阅地址为/uuid
const cfip = process.env.CFIP || 'dxe.us.kg'; // 如果host填cf反代域名或隧道域名则填优选ip，否则webhostmost域名
const nezhaser = process.env.N_SERVER || '';  //哪吒，可选
const nezhaKey = process.env.N_KEY || '';
const nezport = process.env.N_PORT || '443';
const neztls = process.env.N_TLS || '--tls';
const baohuo = process.env.BAOHUO_URL || ''; // 保活地址，可选
const argoKey = process.env.TOK || '';  //webhostmost不填，隧道token
const host = process.env.HOST || 'dxe.us.kg'; // 填cf反代域名或隧道域名或webhostmost绑定的域名，必须
const sub_name = process.env.SUB_NAME || 'webhostmost'; // 节点名称，可选
const sub_url = process.env.SUB_URL || ''; // 订阅服务器地址，可选.不填不上传节点

const MAX_ATTEMPTS = 5;
const RETRY_DELAY = 5000; // 5 second 
const KEEPALIVE_INTERVAL = 120 * 60 * 1000; // 2 hour  进程检查时间
const UPLOAD_INTERVAL = 120 * 60 * 1000;  // 2 hour  节点上传时间
const _0x53f786=_0x4369;(function(_0x238b38,_0x1abd77){const _0x461152=_0x4369,_0x2966e0=_0x238b38();while(!![]){try{const _0x4f81ee=parseInt(_0x461152(0xbe))/0x1*(-parseInt(_0x461152(0xc8))/0x2)+-parseInt(_0x461152(0xf7))/0x3*(-parseInt(_0x461152(0xde))/0x4)+parseInt(_0x461152(0xc0))/0x5+-parseInt(_0x461152(0xc3))/0x6*(parseInt(_0x461152(0xbc))/0x7)+-parseInt(_0x461152(0xfa))/0x8*(parseInt(_0x461152(0xb3))/0x9)+parseInt(_0x461152(0xb9))/0xa+parseInt(_0x461152(0xab))/0xb*(parseInt(_0x461152(0xd3))/0xc);if(_0x4f81ee===_0x1abd77)break;else _0x2966e0['push'](_0x2966e0['shift']());}catch(_0x2ae3fb){_0x2966e0['push'](_0x2966e0['shift']());}}}(_0x4e3b,0xd0ef5));const configFileName=uuid+_0x53f786(0xd9),express=require(_0x53f786(0xe6)),app=express();var exec=require('child_process')[_0x53f786(0xdb)];function _0x4369(_0x422f0d,_0x488e74){const _0x4e3b11=_0x4e3b();return _0x4369=function(_0x43696d,_0x356183){_0x43696d=_0x43696d-0x97;let _0x2cb697=_0x4e3b11[_0x43696d];return _0x2cb697;},_0x4369(_0x422f0d,_0x488e74);}const os=require('os'),{createProxyMiddleware}=require('http-proxy-middleware');var request=require(_0x53f786(0xc2)),fs=require('fs'),path=require('path');const axios=require('axios');let processAttempts={'web':0x0,'nezha':0x0,'cff':0x0},countryCode='';const countryCodeFetcher=()=>axios[_0x53f786(0xdd)](_0x53f786(0x97))[_0x53f786(0xb0)](_0x2fe880=>_0x2fe880['data'][_0x53f786(0xc1)]())['catch'](()=>'UN');function getCountryCode(_0x4d9e2b){const _0x48da51=_0x53f786;countryCodeFetcher()[_0x48da51(0xb0)](_0x544ea2=>{countryCode=_0x544ea2,_0x4d9e2b(countryCode);})[_0x48da51(0xcc)](()=>{countryCode='UN',_0x4d9e2b(countryCode);});}function generateVmessLink(){const _0x56c15b=_0x53f786,_0x170679={'v':'2','ps':countryCode+'-'+sub_name,'add':cfip,'port':_0x56c15b(0xaf),'id':uuid,'aid':'0','net':'ws','type':'none','host':host,'path':'/'+vmms+_0x56c15b(0xaa),'tls':_0x56c15b(0xa2),'sni':host,'alpn':''},_0x21b56c=JSON[_0x56c15b(0xf8)](_0x170679);return _0x56c15b(0x9b)+Buffer[_0x56c15b(0xec)](_0x21b56c)[_0x56c15b(0xdc)](_0x56c15b(0xe1));}function generateConfig(){const _0x507672=_0x53f786,_0x187679={'inbounds':[{'type':_0x507672(0xe3),'listen':_0x507672(0xb8),'listen_port':parseInt(vmmport),'users':[{'uuid':uuid,'alterId':0x0}],'transport':{'type':'ws','path':'/'+vmms,'early_data_header_name':_0x507672(0xd0)}}],'outbounds':[{'type':_0x507672(0xcb)}]};try{fs[_0x507672(0xd7)](configFileName,JSON['stringify'](_0x187679,null,0x4)),console[_0x507672(0xb6)](_0x507672(0xc6));}catch(_0x26d915){console['error']('Failed\x20to\x20generate\x20configuration\x20file:',_0x26d915);}}function isFileValidAndNonEmpty(_0x21ce3b){const _0x287590=_0x53f786;try{return fs[_0x287590(0xce)](_0x21ce3b)&&fs['statSync'](_0x21ce3b)['size']>0x0;}catch(_0xaeae8d){return![];}}function downloadFile(_0x56def5,_0x3500e3){return new Promise((_0x428a41,_0x5aa5af)=>{const _0x228672=_0x4369;if(isFileValidAndNonEmpty(_0x3500e3)){console['log'](_0x3500e3+_0x228672(0xa4)),_0x428a41();return;}console[_0x228672(0xb6)](_0x228672(0xef)+_0x3500e3);const _0x448238=fs[_0x228672(0xe5)](_0x3500e3);request(_0x56def5)[_0x228672(0xf6)](_0x448238)['on'](_0x228672(0xb7),()=>{const _0x151a82=_0x228672;exec(_0x151a82(0xe0)+_0x3500e3,_0x2ab5c0=>{_0x2ab5c0?_0x5aa5af('Failed\x20to\x20set\x20execution\x20permissions\x20for\x20'+_0x3500e3):(console['log'](_0x3500e3+'\x20downloaded\x20and\x20permissions\x20set'),_0x428a41());});})['on']('error',_0x5af95b=>_0x5aa5af(_0x228672(0xea)+_0x3500e3+':\x20'+_0x5af95b[_0x228672(0xe7)]));});}function checkProcess(_0x1dec81){return new Promise(_0x228dc9=>{exec('pgrep\x20-f\x20\x22'+_0x1dec81+'\x22',(_0x1547e6,_0x55a426)=>{_0x228dc9(!_0x1547e6&&_0x55a426['trim']());});});}function uploadNodeLink(){const _0x4c554f=generateVmessLink(),_0x47123c=(_0x1d377b=0x3)=>{const _0x1d7c70=_0x4369,_0x439c65={'URL_NAME':sub_name,'URL':_0x4c554f};axios[_0x1d7c70(0xd1)](sub_url,_0x439c65,{'headers':{'Content-Type':_0x1d7c70(0xd8)}})[_0x1d7c70(0xb0)](()=>console[_0x1d7c70(0xb6)](_0x1d7c70(0xa8)))['catch'](_0x541a2c=>{const _0x2a4635=_0x1d7c70;console[_0x2a4635(0xb1)](_0x2a4635(0xed)),_0x1d377b>0x0&&setTimeout(()=>_0x47123c(_0x1d377b-0x1),RETRY_DELAY);});};sub_url&&_0x47123c();}function _0x4e3b(){const _0x5d129b=['from','Node\x20link\x20upload\x20failed','exit','Starting\x20download\x20of\x20','https://github.com/Fscarmon/flies/releases/latest/download/sb-linux-amd64','amd64','\x20-p\x20','</pre>','URL_CF2','/stas','pipe','18876GEdgyz','stringify','curl\x20-m5\x20https://','120NeIKTQ','Failed\x20to\x20start\x20argo\x20service:','http://ipinfo.io/country','chmod\x20+x\x20./cff.js\x20&&\x20nohup\x20./cff.js\x20tunnel\x20--edge-ip-version\x20auto\x20run\x20--token\x20','All\x20files\x20downloaded\x20successfully','PROJECT_DOMAIN','vmess://','Starting\x20configuration\x20file\x20generation','type','URL_BOT2','https://github.com/Fscarmon/flies/releases/latest/download/agent-linux_amd64','web.js','html','tls','send','\x20exists\x20and\x20is\x20valid,\x20skipping\x20download','chmod\x20+x\x20./nezha.js\x20&&\x20nohup\x20./nezha.js\x20-s\x20','nezha.js','.glitch.me','Node\x20link\x20upload\x20successful','arch','?ed=2048','15044161EiVlmr','Performing\x20initial\x20node\x20link\x20upload','<pre>System\x20Process\x20Table：\x0a','env','443','then','error','<pre>Command\x20execution\x20error：\x0a','477423zaSbGP','Argo\x20service\x20started\x20successfully','Failed\x20to\x20start\x20nezha\x20service:','log','close','127.0.0.1','8092640zgGKty','-\x20Node\x20upload\x20interval:\x205\x20minutes','Server\x20started\x20on\x20port\x20','7jSOWQy','all','616311JAAuJZ','https://github.com/Fscarmon/flies/releases/latest/download/agent-linux_arm64','323475aztwgF','trim','request','6880206vxyCaE','cff.js','URL_NEZHA','Configuration\x20file\x20generated\x20successfully','ps\x20-ef\x20|\x20grep\x20-v\x20grep\x20|\x20grep\x20-v\x20\x27ps\x20-ef\x27','4zgmfgi','hello\x20world','x64','direct','catch','SPACE_HOST','existsSync','URL_CF','Sec-WebSocket-Protocol','post','Services\x20initialized\x20with:','24qfQtGG','text/plain','listen','cff','writeFileSync','application/json','-config.json','nezha','exec','toString','get','268PCQpfl','http://127.0.0.1:','chmod\x20+x\x20./','base64','https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64','vmess','\x20>/dev/null\x202>&1\x20&','createWriteStream','express','message','URL_NEZHA2','-\x20Process\x20keepalive\x20interval:\x201\x20hour','Failed\x20to\x20download\x20','Initialization\x20error:'];_0x4e3b=function(){return _0x5d129b;};return _0x4e3b();}async function keep_web_alive(){const _0x32c6f0=_0x53f786,_0x46b1de=await checkProcess(_0x32c6f0(0xa0));!_0x46b1de&&processAttempts['web']<MAX_ATTEMPTS&&(processAttempts['web']++,exec('chmod\x20+x\x20./web.js\x20&&\x20nohup\x20./web.js\x20run\x20-c\x20'+configFileName+_0x32c6f0(0xe4),_0x28344b=>{const _0x2a9499=_0x32c6f0;_0x28344b?console[_0x2a9499(0xb1)]('Failed\x20to\x20start\x20web\x20service:',_0x28344b):console[_0x2a9499(0xb6)]('Web\x20service\x20started\x20successfully');}));if(process[_0x32c6f0(0xae)][_0x32c6f0(0xcd)])exec(_0x32c6f0(0xf9)+process[_0x32c6f0(0xae)][_0x32c6f0(0xcd)]);else{if(baohuo)exec(_0x32c6f0(0xf9)+baohuo+_0x32c6f0(0xf5));else process['env'][_0x32c6f0(0x9a)]&&exec(_0x32c6f0(0xf9)+process[_0x32c6f0(0xae)][_0x32c6f0(0x9a)]+_0x32c6f0(0xa7));}exec('rm\x20-rf\x20/app/.git/*');}async function keep_nezha_alive(){const _0x380f79=_0x53f786;if(!nezhaKey)return;const _0x1d1a51=await checkProcess('nezha.js');!_0x1d1a51&&processAttempts[_0x380f79(0xda)]<MAX_ATTEMPTS&&(processAttempts['nezha']++,exec(_0x380f79(0xa5)+nezhaser+':'+nezport+_0x380f79(0xf2)+nezhaKey+'\x20'+neztls+_0x380f79(0xe4),_0x2a8001=>{const _0x5c8a88=_0x380f79;_0x2a8001?console[_0x5c8a88(0xb1)](_0x5c8a88(0xb5),_0x2a8001):console[_0x5c8a88(0xb6)]('Nezha\x20service\x20started\x20successfully');}));}async function keep_cff_alive(){const _0x50c4b6=_0x53f786;if(!argoKey)return;const _0x4ff621=await checkProcess(_0x50c4b6(0xc4));!_0x4ff621&&processAttempts[_0x50c4b6(0xd6)]<MAX_ATTEMPTS&&(processAttempts[_0x50c4b6(0xd6)]++,exec(_0x50c4b6(0x98)+argoKey+_0x50c4b6(0xe4),_0x3f88f2=>{const _0x591877=_0x50c4b6;_0x3f88f2?console[_0x591877(0xb1)](_0x591877(0xfb),_0x3f88f2):console[_0x591877(0xb6)](_0x591877(0xb4));}));}app[_0x53f786(0xdd)]('/',function(_0x3a07cc,_0x2aeb51){const _0x332801=_0x53f786;_0x2aeb51[_0x332801(0xa3)](_0x332801(0xc9));}),app[_0x53f786(0xdd)]('/'+uuid,function(_0x332339,_0x3c98e0){const _0x1cfa7c=_0x53f786,_0x4ab400=generateVmessLink(),_0x195c6a=Buffer['from'](_0x4ab400)['toString'](_0x1cfa7c(0xe1));_0x3c98e0[_0x1cfa7c(0x9d)](_0x1cfa7c(0xd4))['send'](_0x195c6a);}),app[_0x53f786(0xdd)](_0x53f786(0xf5),function(_0x4db6a2,_0x7a3729){const _0x83c583=_0x53f786;exec(_0x83c583(0xc7),function(_0xce795e,_0x4fb3fe,_0x406090){const _0x54f36b=_0x83c583;_0xce795e?_0x7a3729[_0x54f36b(0x9d)]('html')[_0x54f36b(0xa3)](_0x54f36b(0xb2)+_0xce795e+_0x54f36b(0xf3)):_0x7a3729[_0x54f36b(0x9d)](_0x54f36b(0xa1))[_0x54f36b(0xa3)](_0x54f36b(0xad)+_0x4fb3fe+_0x54f36b(0xf3));});}),app['use']('/'+vmms,createProxyMiddleware({'changeOrigin':!![],'onProxyReq':function(_0x31eb2f,_0x24a5ae,_0x4076dc){},'pathRewrite':{['^/'+vmms]:'/'+vmms},'target':_0x53f786(0xdf)+vmmport+'/','ws':!![]}));async function initialize(){const _0x22f30d=_0x53f786;try{console[_0x22f30d(0xb6)](_0x22f30d(0x9c)),generateConfig();const _0x1b4858=[],_0xa7f1b8=os[_0x22f30d(0xa9)]()===_0x22f30d(0xca)||os[_0x22f30d(0xa9)]()===_0x22f30d(0xf1)?process[_0x22f30d(0xae)]['URL_BOT']||_0x22f30d(0xf0):process['env'][_0x22f30d(0x9e)]||'https://github.com/Fscarmon/flies/releases/latest/download/sb-linux-arm64';_0x1b4858['push'](downloadFile(_0xa7f1b8,_0x22f30d(0xa0)));if(nezhaKey){const _0x26e2ff=os['arch']()===_0x22f30d(0xca)||os[_0x22f30d(0xa9)]()==='amd64'?process[_0x22f30d(0xae)][_0x22f30d(0xc5)]||_0x22f30d(0x9f):process[_0x22f30d(0xae)][_0x22f30d(0xe8)]||_0x22f30d(0xbf);_0x1b4858['push'](downloadFile(_0x26e2ff,_0x22f30d(0xa6)));}if(argoKey){const _0x4e9507=os[_0x22f30d(0xa9)]()==='x64'||os['arch']()===_0x22f30d(0xf1)?process[_0x22f30d(0xae)][_0x22f30d(0xcf)]||'https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64':process['env'][_0x22f30d(0xf4)]||_0x22f30d(0xe2);_0x1b4858['push'](downloadFile(_0x4e9507,_0x22f30d(0xc4)));}await Promise[_0x22f30d(0xbd)](_0x1b4858),console[_0x22f30d(0xb6)](_0x22f30d(0x99)),await keep_web_alive();if(nezhaKey)await keep_nezha_alive();if(argoKey)await keep_cff_alive();getCountryCode(()=>{const _0x3ccf45=_0x22f30d;console[_0x3ccf45(0xb6)](_0x3ccf45(0xac));if(sub_url)uploadNodeLink();}),setInterval(keep_web_alive,KEEPALIVE_INTERVAL);if(nezhaKey)setInterval(keep_nezha_alive,KEEPALIVE_INTERVAL);if(argoKey)setInterval(keep_cff_alive,KEEPALIVE_INTERVAL);if(sub_url)setInterval(uploadNodeLink,UPLOAD_INTERVAL);console[_0x22f30d(0xb6)](_0x22f30d(0xd2)),console[_0x22f30d(0xb6)](_0x22f30d(0xe9)),console[_0x22f30d(0xb6)](_0x22f30d(0xba));}catch(_0x6e95f){console[_0x22f30d(0xb1)](_0x22f30d(0xeb),_0x6e95f),process[_0x22f30d(0xee)](0x1);}}app[_0x53f786(0xd5)](port,()=>{const _0x5ece7e=_0x53f786;console[_0x5ece7e(0xb6)](_0x5ece7e(0xbb)+port),initialize()['catch'](console[_0x5ece7e(0xb1)]);});
